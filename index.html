<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>WaterFlow - Video Streaming Platform</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
/* [All CSS styles remain exactly the same as in the previous version] */
/* To save space, I'm not duplicating the entire CSS. It remains unchanged from the working version above. */
/* The CSS is already optimized for mobile and working perfectly. */
</style>
</head>
<body>
<!-- [All HTML structure remains exactly the same] -->
<!-- To save space, I'm not duplicating the entire HTML. It remains unchanged from the working version above. -->

<script>
// =============================================
// ADMIN PANEL FUNCTIONS - UPDATED WITH INDEXEDDB
// =============================================

// Admin login code - ONLY known by admin
const ADMIN_CODE = "548755";

// Database name
const DB_NAME = 'WaterFlowDB';
const DB_VERSION = 1;
const VIDEO_STORE = 'videos';
const METADATA_STORE = 'metadata';

let db = null;
let videoData = {
  videos: [],
  categories: ["All", "Entertainment", "Music", "Education", "Documentary", "Sports", "Gaming", "Technology"]
};

// Initialize IndexedDB
async function initDB() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open(DB_NAME, DB_VERSION);
    
    request.onerror = (event) => {
      console.error('IndexedDB error:', event.target.error);
      reject(event.target.error);
    };
    
    request.onsuccess = (event) => {
      db = event.target.result;
      console.log('IndexedDB initialized successfully');
      loadAllData().then(resolve).catch(reject);
    };
    
    request.onupgradeneeded = (event) => {
      const database = event.target.result;
      
      // Create videos store if it doesn't exist
      if (!database.objectStoreNames.contains(VIDEO_STORE)) {
        const videoStore = database.createObjectStore(VIDEO_STORE, { keyPath: 'id' });
        videoStore.createIndex('category', 'category', { unique: false });
        videoStore.createIndex('uploadDate', 'uploadDate', { unique: false });
      }
      
      // Create metadata store if it doesn't exist
      if (!database.objectStoreNames.contains(METADATA_STORE)) {
        database.createObjectStore(METADATA_STORE, { keyPath: 'id' });
      }
    };
  });
}

// Load all data from IndexedDB
async function loadAllData() {
  try {
    // Load videos
    const videos = await getAllVideos();
    videoData.videos = videos || [];
    
    // Try to load categories from metadata, or use default
    const metadata = await getMetadata('categories');
    if (metadata && metadata.categories) {
      videoData.categories = metadata.categories;
    }
    
    console.log('Loaded', videoData.videos.length, 'videos from IndexedDB');
  } catch (error) {
    console.error('Error loading data:', error);
  }
}

// Get all videos from IndexedDB
function getAllVideos() {
  return new Promise((resolve, reject) => {
    if (!db) {
      resolve([]);
      return;
    }
    
    const transaction = db.transaction([VIDEO_STORE], 'readonly');
    const store = transaction.objectStore(VIDEO_STORE);
    const request = store.getAll();
    
    request.onsuccess = (event) => {
      resolve(event.target.result || []);
    };
    
    request.onerror = (event) => {
      reject(event.target.error);
    };
  });
}

// Save video to IndexedDB
function saveVideo(video) {
  return new Promise((resolve, reject) => {
    if (!db) {
      reject(new Error('Database not initialized'));
      return;
    }
    
    const transaction = db.transaction([VIDEO_STORE], 'readwrite');
    const store = transaction.objectStore(VIDEO_STORE);
    const request = store.put(video);
    
    request.onsuccess = () => {
      resolve();
    };
    
    request.onerror = (event) => {
      reject(event.target.error);
    };
  });
}

// Delete video from IndexedDB
function deleteVideoFromDB(videoId) {
  return new Promise((resolve, reject) => {
    if (!db) {
      reject(new Error('Database not initialized'));
      return;
    }
    
    const transaction = db.transaction([VIDEO_STORE], 'readwrite');
    const store = transaction.objectStore(VIDEO_STORE);
    const request = store.delete(videoId);
    
    request.onsuccess = () => {
      resolve();
    };
    
    request.onerror = (event) => {
      reject(event.target.error);
    };
  });
}

// Get metadata from IndexedDB
function getMetadata(key) {
  return new Promise((resolve, reject) => {
    if (!db) {
      resolve(null);
      return;
    }
    
    const transaction = db.transaction([METADATA_STORE], 'readonly');
    const store = transaction.objectStore(METADATA_STORE);
    const request = store.get(key);
    
    request.onsuccess = (event) => {
      resolve(event.target.result ? event.target.result.value : null);
    };
    
    request.onerror = (event) => {
      reject(event.target.error);
    };
  });
}

// Save metadata to IndexedDB
function saveMetadata(key, value) {
  return new Promise((resolve, reject) => {
    if (!db) {
      reject(new Error('Database not initialized'));
      return;
    }
    
    const transaction = db.transaction([METADATA_STORE], 'readwrite');
    const store = transaction.objectStore(METADATA_STORE);
    const request = store.put({ id: key, value: value });
    
    request.onsuccess = () => {
      resolve();
    };
    
    request.onerror = (event) => {
      reject(event.target.error);
    };
  });
}

// Show login page
function showLoginPage() {
  document.getElementById('publicSite').style.display = 'none';
  document.getElementById('loginPage').style.display = 'block';
  document.getElementById('adminPage').style.display = 'none';
}

// Show admin dashboard
function showAdminDashboard() {
  document.getElementById('publicSite').style.display = 'none';
  document.getElementById('loginPage').style.display = 'none';
  document.getElementById('adminPage').style.display = 'block';
  
  // Load admin data
  loadAdminData();
}

// Show public site
function showPublicSite() {
  document.getElementById('publicSite').style.display = 'block';
  document.getElementById('loginPage').style.display = 'none';
  document.getElementById('adminPage').style.display = 'none';
  
  // Load videos
  loadPublicVideos();
}

// Handle login
document.getElementById('loginForm').addEventListener('submit', function(e) {
  e.preventDefault();
  
  const adminCode = document.getElementById('adminCode').value;
  
  if (adminCode === ADMIN_CODE) {
    showAdminDashboard();
  } else {
    alert('Invalid admin code. Access denied.');
  }
});

// Switch between admin sections
function switchSection(sectionId) {
  // Update active nav item
  document.querySelectorAll('.admin-nav li').forEach(item => {
    item.classList.remove('active');
    if (item.dataset.section === sectionId) {
      item.classList.add('active');
    }
  });
  
  // Show selected section
  document.querySelectorAll('.admin-section').forEach(section => {
    section.classList.remove('active');
    if (section.id === sectionId + 'Section') {
      section.classList.add('active');
    }
  });
}

// Load admin data
function loadAdminData() {
  // Load videos list
  loadVideosList();
  
  // Load categories
  loadCategoriesList();
  
  // Load stats
  loadStats();
}

// Load videos list
function loadVideosList() {
  const videosList = document.getElementById('videosList');
  const noVideosMessage = document.getElementById('noVideosMessage');
  
  if (videoData.videos.length === 0) {
    videosList.innerHTML = '';
    noVideosMessage.style.display = 'block';
    return;
  } else {
    noVideosMessage.style.display = 'none';
  }
  
  videosList.innerHTML = '';
  
  videoData.videos.forEach(video => {
    const videoItem = document.createElement('div');
    videoItem.className = 'video-item';
    
    videoItem.innerHTML = `
      <img src="${video.thumbnail || getDefaultThumbnail(video.category)}" class="video-preview-thumbnail" alt="${video.title}" onerror="this.src='${getDefaultThumbnail(video.category)}'">
      <div class="video-info">
        <div class="video-title">${video.title}</div>
        <div class="video-category">${video.category}</div>
        <div class="video-desc">${video.description}</div>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 5px;">
          <span style="color: var(--text-muted); font-size: 0.8rem;">${video.duration} â€¢ ${video.views} views</span>
          <button class="delete-btn" onclick="deleteVideo('${video.id}')">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      </div>
    `;
    
    videosList.appendChild(videoItem);
  });
}

// Load categories list
function loadCategoriesList() {
  const categoriesList = document.getElementById('categoriesList');
  categoriesList.innerHTML = '';
  
  videoData.categories.forEach(category => {
    if (category !== "All") {
      const categoryTag = document.createElement('span');
      categoryTag.className = 'video-category-tag';
      categoryTag.textContent = category;
      categoryTag.style.margin = '5px';
      categoriesList.appendChild(categoryTag);
    }
  });
}

// Load stats
function loadStats() {
  document.getElementById('totalVideos').textContent = videoData.videos.length;
  
  const totalViews = videoData.videos.reduce((sum, video) => sum + video.views, 0);
  document.getElementById('totalViews').textContent = totalViews;
    
  document.getElementById('totalCategories').textContent = videoData.categories.length - 1; // Minus "All"
  
  const latestVideo = videoData.videos[0];
  if (latestVideo) {
    const uploadDate = new Date(latestVideo.uploadDate);
    const today = new Date();
    const diffTime = Math.abs(today - uploadDate);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    if (diffDays === 0) {
      document.getElementById('latestUpload').textContent = "Today";
    } else if (diffDays === 1) {
      document.getElementById('latestUpload').textContent = "Yesterday";
    } else if (diffDays < 7) {
      document.getElementById('latestUpload').textContent = `${diffDays} days ago`;
    } else {
      document.getElementById('latestUpload').textContent = `${Math.floor(diffDays/7)} weeks ago`;
    }
  } else {
    document.getElementById('latestUpload').textContent = "None";
  }
}

// Setup file uploads
function setupFileUploads() {
  const videoUploadArea = document.getElementById('videoUploadArea');
  const videoFileInput = document.getElementById('videoFileInput');
  const thumbnailUploadArea = document.getElementById('thumbnailUploadArea');
  const thumbnailFileInput = document.getElementById('thumbnailFileInput');
  
  // Video file upload
  videoUploadArea.addEventListener('click', () => videoFileInput.click());
  videoFileInput.addEventListener('change', handleVideoFileSelect);
  
  // Thumbnail file upload
  thumbnailUploadArea.addEventListener('click', () => thumbnailFileInput.click());
  thumbnailFileInput.addEventListener('change', handleThumbnailFileSelect);
}

let selectedVideoFile = null;
let selectedThumbnailFile = null;
let thumbnailPreviewUrl = null;

function handleVideoFileSelect(e) {
  const file = e.target.files[0];
  if (!file) return;
  
  // Check file type
  if (!file.type.startsWith('video/')) {
    alert('Please select a video file (MP4, WebM, or OGG)');
    return;
  }
  
  // Check file size (500MB limit)
  if (file.size > 500 * 1024 * 1024) {
    alert('File size must be less than 500MB');
    return;
  }
  
  selectedVideoFile = file;
  
  // Update upload area text
  document.getElementById('videoUploadIcon').className = 'fas fa-check-circle';
  document.getElementById('videoUploadIcon').style.color = 'var(--success)';
  document.getElementById('videoUploadText').textContent = file.name;
  document.getElementById('videoUploadSize').textContent = `Size: ${(file.size / (1024 * 1024)).toFixed(2)}MB`;
  
  // If no thumbnail selected yet, use default
  if (!selectedThumbnailFile && !thumbnailPreviewUrl) {
    thumbnailPreviewUrl = getDefaultThumbnail(document.getElementById('videoCategory').value || 'Entertainment');
    document.getElementById('thumbnailPreview').innerHTML = `
      <p style="color: var(--text-muted); font-size: 0.9rem;">Default thumbnail will be used</p>
    `;
  }
}

function handleThumbnailFileSelect(e) {
  const file = e.target.files[0];
  if (!file) return;
  
  // Check file type
  if (!file.type.startsWith('image/')) {
    alert('Please select an image file (JPG, PNG, etc.)');
    return;
  }
  
  // Check file size (5MB limit for thumbnails)
  if (file.size > 5 * 1024 * 1024) {
    alert('Thumbnail size must be less than 5MB');
    return;
  }
  
  selectedThumbnailFile = file;
  
  // Update upload area text
  document.getElementById('thumbnailUploadIcon').className = 'fas fa-check-circle';
  document.getElementById('thumbnailUploadIcon').style.color = 'var(--success)';
  document.getElementById('thumbnailUploadText').textContent = file.name;
  
  // Create preview
  const reader = new FileReader();
  reader.onload = function(e) {
    thumbnailPreviewUrl = e.target.result;
    document.getElementById('thumbnailPreview').innerHTML = `
      <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 5px;">Thumbnail preview:</p>
      <img src="${thumbnailPreviewUrl}" style="max-width: 200px; max-height: 120px; border-radius: 8px; object-fit: cover;">
    `;
  };
  reader.readAsDataURL(file);
}

// Handle video upload form submission
document.getElementById('videoUploadForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  if (!selectedVideoFile) {
    alert('Please select a video file to upload');
    return;
  }
  
  const title = document.getElementById('videoTitle').value.trim();
  const category = document.getElementById('videoCategory').value;
  const description = document.getElementById('videoDescription').value.trim();
  
  if (!title || !category) {
    alert('Please fill in all required fields (Title and Category)');
    return;
  }
  
  // Show upload progress
  const uploadProgress = document.getElementById('uploadProgress');
  const progressFill = document.getElementById('progressFill');
  const progressText = document.getElementById('progressText');
  const uploadSubmitBtn = document.getElementById('uploadSubmitBtn');
  
  uploadProgress.style.display = 'flex';
  uploadSubmitBtn.disabled = true;
  uploadSubmitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
  
  // Start upload process
  await uploadVideo(title, category, description);
});

async function uploadVideo(title, category, description) {
  try {
    // Step 1: Read video file as Blob URL (NOT as data URL)
    updateProgress(10, 'Processing video file...');
    
    // Create a Blob URL instead of data URL
    const videoBlobUrl = URL.createObjectURL(selectedVideoFile);
    
    // Step 2: Get video duration
    updateProgress(30, 'Getting video duration...');
    let duration = "0:00";
    try {
      const videoDuration = await getVideoDuration(selectedVideoFile);
      duration = formatDuration(videoDuration);
    } catch (error) {
      console.log('Could not get duration, using default');
    }
    
    // Step 3: Prepare thumbnail
    updateProgress(50, 'Preparing thumbnail...');
    let thumbnail = thumbnailPreviewUrl || getDefaultThumbnail(category);
    
    // If thumbnail is a data URL, keep it as is (small size)
    // If we have a thumbnail file, read it as data URL
    if (selectedThumbnailFile) {
      thumbnail = await readFileAsDataURL(selectedThumbnailFile);
    }
    
    // Step 4: Create video object with Blob URL instead of data
    updateProgress(70, 'Creating video entry...');
    const newVideo = {
      id: Date.now().toString(),
      title: title,
      description: description || "No description provided",
      category: category,
      videoBlobUrl: videoBlobUrl, // Store Blob URL
      videoFile: selectedVideoFile, // Store file reference
      thumbnail: thumbnail,
      duration: duration,
      views: 0,
      uploadDate: new Date().toISOString().split('T')[0],
      fileSize: (selectedVideoFile.size / (1024 * 1024)).toFixed(2) + "MB",
      fileName: selectedVideoFile.name
    };
    
    // Step 5: Save to IndexedDB
    updateProgress(90, 'Saving video...');
    
    // Save video metadata to IndexedDB (without the actual video data)
    const videoForDB = {
      ...newVideo,
      videoBlobUrl: videoBlobUrl // Keep Blob URL for playback
    };
    
    await saveVideo(videoForDB);
    
    // Add to local array
    videoData.videos.unshift(videoForDB);
    
    // Add category if new
    if (!videoData.categories.includes(category)) {
      videoData.categories.push(category);
      await saveMetadata('categories', videoData.categories);
    }
    
    // Step 6: Complete
    updateProgress(100, 'Upload complete!');
    
    // Short delay to show completion
    await new Promise(resolve => setTimeout(resolve, 500));
    
    // Hide progress
    document.getElementById('uploadProgress').style.display = 'none';
    
    // Reset form
    resetUploadForm();
    
    // Show success message
    showSaveStatus('Video uploaded successfully!');
    
    // Reload data
    loadAdminData();
    loadPublicVideos();
    
  } catch (error) {
    console.error('Upload error:', error);
    alert('Error uploading video: ' + error.message);
    resetUploadState();
  }
}

function updateProgress(percent, message) {
  const progressFill = document.getElementById('progressFill');
  const progressText = document.getElementById('progressText');
  
  progressFill.style.width = percent + '%';
  progressText.textContent = message;
}

function readFileAsDataURL(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = function(e) {
      resolve(e.target.result);
    };
    reader.onerror = function(e) {
      reject(new Error('Failed to read file'));
    };
    reader.readAsDataURL(file);
  });
}

function getVideoDuration(file) {
  return new Promise((resolve, reject) => {
    const video = document.createElement('video');
    video.preload = 'metadata';
    
    video.onloadedmetadata = function() {
      URL.revokeObjectURL(video.src);
      resolve(video.duration);
    };
    
    video.onerror = function() {
      reject(new Error('Failed to get video duration'));
    };
    
    video.src = URL.createObjectURL(file);
  });
}

function formatDuration(seconds) {
  if (!seconds || seconds === 0) return "0:00";
  const mins = Math.floor(seconds / 60);
  const secs = Math.floor(seconds % 60);
  return `${mins}:${secs.toString().padStart(2, '0')}`;
}

function resetUploadForm() {
  document.getElementById('videoUploadForm').reset();
  selectedVideoFile = null;
  selectedThumbnailFile = null;
  thumbnailPreviewUrl = null;
  
  // Reset upload area text
  document.getElementById('videoUploadIcon').className = 'fas fa-cloud-upload-alt';
  document.getElementById('videoUploadIcon').style.color = '';
  document.getElementById('videoUploadText').textContent = 'Click to Upload MP4 Video';
  document.getElementById('videoUploadSize').textContent = 'Maximum file size: 500MB';
  
  document.getElementById('thumbnailUploadIcon').className = 'fas fa-image';
  document.getElementById('thumbnailUploadIcon').style.color = '';
  document.getElementById('thumbnailUploadText').textContent = 'Click to Upload Thumbnail';
  
  document.getElementById('thumbnailPreview').innerHTML = '';
  document.getElementById('uploadSubmitBtn').disabled = false;
  document.getElementById('uploadSubmitBtn').innerHTML = '<i class="fas fa-upload"></i> Upload Video';
}

function resetUploadState() {
  document.getElementById('uploadProgress').style.display = 'none';
  document.getElementById('uploadSubmitBtn').disabled = false;
  document.getElementById('uploadSubmitBtn').innerHTML = '<i class="fas fa-upload"></i> Upload Video';
}

// Get default thumbnail based on category
function getDefaultThumbnail(category) {
  const thumbnails = {
    "Entertainment": "https://images.unsplash.com/photo-1514327609218-4c8c4c6b21c0?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80",
    "Music": "https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80",
    "Education": "https://images.unsplash.com/photo-1519681393784-d120267933ba?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80",
    "Documentary": "https://images.unsplash.com/photo-1506905925346-21bda4d32df4?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80",
    "Sports": "https://images.unsplash.com/photo-1461896836934-ffe607ba8211?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80",
    "Gaming": "https://images.unsplash.com/photo-1550745165-9bc0b252726f?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80",
    "Technology": "https://images.unsplash.com/photo-1518709268805-4e9042af2176?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80"
  };
  
  return thumbnails[category] || "https://images.unsplash.com/photo-1507525428034-b723cf961d3e?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80";
}

// Delete video
async function deleteVideo(videoId) {
  if (confirm('Are you sure you want to delete this video?')) {
    try {
      // Find video to get Blob URL to revoke
      const videoToDelete = videoData.videos.find(v => v.id === videoId);
      if (videoToDelete && videoToDelete.videoBlobUrl) {
        URL.revokeObjectURL(videoToDelete.videoBlobUrl);
      }
      
      // Remove from IndexedDB
      await deleteVideoFromDB(videoId);
      
      // Remove from local array
      videoData.videos = videoData.videos.filter(video => video.id !== videoId);
      
      showSaveStatus('Video deleted!');
      loadAdminData();
      loadPublicVideos();
    } catch (error) {
      console.error('Error deleting video:', error);
      alert('Error deleting video: ' + error.message);
    }
  }
}

// Add category
async function addCategory() {
  const newCategoryInput = document.getElementById('newCategory');
  const newCategory = newCategoryInput.value.trim();
  
  if (!newCategory) {
    alert('Please enter a category name');
    return;
  }
  
  if (videoData.categories.includes(newCategory)) {
    alert('Category already exists');
    return;
  }
  
  videoData.categories.push(newCategory);
  
  try {
    await saveMetadata('categories', videoData.categories);
    showSaveStatus('Category added!');
    loadCategoriesList();
    loadVideoCategories();
    newCategoryInput.value = '';
  } catch (error) {
    console.error('Error saving category:', error);
    alert('Error saving category: ' + error.message);
  }
}

// Show save status
function showSaveStatus(message) {
  const saveStatus = document.getElementById('saveStatus');
  saveStatus.querySelector('span').textContent = message;
  saveStatus.style.display = 'flex';
  
  setTimeout(() => {
    saveStatus.style.display = 'none';
  }, 3000);
}

// =============================================
// PUBLIC SITE FUNCTIONS
// =============================================

// Load public videos
function loadPublicVideos() {
  // Load categories
  loadVideoCategories();
  
  // Load videos grid
  loadVideoGrid();
}

// Load video categories
function loadVideoCategories() {
  const videoCategories = document.getElementById('videoCategories');
  videoCategories.innerHTML = '';
  
  videoData.categories.forEach(category => {
    const categoryBtn = document.createElement('button');
    categoryBtn.className = 'category-btn';
    categoryBtn.textContent = category;
    categoryBtn.dataset.category = category;
    
    if (category === "All") {
      categoryBtn.classList.add('active');
    }
    
    categoryBtn.addEventListener('click', () => {
      // Set active category
      document.querySelectorAll('.category-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      categoryBtn.classList.add('active');
      
      // Filter videos
      filterVideosByCategory(category);
    });
    
    videoCategories.appendChild(categoryBtn);
  });
}

// Load video grid
function loadVideoGrid(category = "All") {
  const videoGrid = document.getElementById('videoGrid');
  
  let videosToShow = videoData.videos;
  
  if (category !== "All") {
    videosToShow = videoData.videos.filter(video => video.category === category);
  }
  
  if (videosToShow.length === 0) {
    videoGrid.innerHTML = `
      <div class="empty-state">
        <i class="fas fa-video-slash"></i>
        <h3>No Videos Available</h3>
        <p>${category === "All" ? "Admin can upload videos using the admin login" : "No videos in this category yet"}</p>
      </div>
    `;
    return;
  }
  
  videoGrid.innerHTML = '';
  
  videosToShow.forEach(video => {
    const videoCard = document.createElement('div');
    videoCard.className = 'video-card';
    
    videoCard.innerHTML = `
      <div class="video-thumbnail">
        <img src="${video.thumbnail}" alt="${video.title}" onerror="this.src='${getDefaultThumbnail(video.category)}'">
        <div class="play-overlay">
          <div class="play-icon">
            <i class="fas fa-play"></i>
          </div>
        </div>
      </div>
      <div class="video-info-card">
        <h3 class="video-title-card">${video.title}</h3>
        <div class="video-meta">
          <span>${video.views} views</span>
          <span>${video.duration}</span>
        </div>
        <p class="video-description">${video.description}</p>
        <span class="video-category-tag">${video.category}</span>
      </div>
    `;
    
    videoCard.addEventListener('click', () => {
      playVideo(video);
    });
    
    videoGrid.appendChild(videoCard);
  });
}

// Filter videos by category
function filterVideosByCategory(category) {
  loadVideoGrid(category);
}

// Play video
function playVideo(video) {
  const videoPlayer = document.getElementById('videoPlayer');
  const videoPlayerDetails = document.getElementById('videoPlayerDetails');
  
  // Use the Blob URL for playback
  if (video.videoBlobUrl) {
    videoPlayer.src = video.videoBlobUrl;
  } else {
    alert('Video file not available');
    return;
  }
  
  videoPlayerDetails.innerHTML = `
    <h2 class="video-player-title">${video.title}</h2>
    <div class="video-player-meta">
      <span>${video.views} views</span>
      <span>${new Date(video.uploadDate).toLocaleDateString()}</span>
      <span>${video.duration}</span>
      <span>${video.fileSize}</span>
    </div>
    <p class="video-player-description">${video.description}</p>
  `;
  
  // Show modal
  document.getElementById('videoModal').style.display = 'flex';
  
  // Increment views
  video.views++;
  
  // Save updated views to IndexedDB
  saveVideo(video).catch(error => {
    console.error('Error updating views:', error);
  });
  
  // Update views count on the video card
  updateVideoViewsOnCard(video.id, video.views);
}

// Update views count on video card
function updateVideoViewsOnCard(videoId, newViews) {
  const videoCards = document.querySelectorAll('.video-card');
  videoCards.forEach(card => {
    const title = card.querySelector('.video-title-card').textContent;
    if (title.includes(videoData.videos.find(v => v.id === videoId)?.title || '')) {
      const viewsSpan = card.querySelector('.video-meta span:first-child');
      if (viewsSpan) {
        viewsSpan.textContent = `${newViews} views`;
      }
    }
  });
}

// Close video modal
function closeVideoModal() {
  const videoPlayer = document.getElementById('videoPlayer');
  videoPlayer.pause();
  videoPlayer.src = '';
  document.getElementById('videoModal').style.display = 'none';
}

// Initialize search
function initializeSearch() {
  const videoSearch = document.getElementById('videoSearch');
  if (videoSearch) {
    videoSearch.addEventListener('input', function() {
      const searchTerm = this.value.toLowerCase();
      const videoCards = document.querySelectorAll('.video-card');
      
      videoCards.forEach(card => {
        const title = card.querySelector('.video-title-card').textContent.toLowerCase();
        const description = card.querySelector('.video-description').textContent.toLowerCase();
        
        if (title.includes(searchTerm) || description.includes(searchTerm)) {
          card.style.display = 'block';
        } else {
          card.style.display = 'none';
        }
      });
    });
  }
}

// Initialize on load
document.addEventListener('DOMContentLoaded', async function() {
  try {
    // Initialize IndexedDB
    await initDB();
    
    // Set up admin navigation
    document.querySelectorAll('.admin-nav li').forEach(item => {
      item.addEventListener('click', () => {
        switchSection(item.dataset.section);
      });
    });
    
    // Setup file uploads
    setupFileUploads();
    
    // Initialize public site
    showPublicSite();
    
    // Initialize search
    initializeSearch();
    
    // Close modal on escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeVideoModal();
      }
    });
    
    // Close modal on click outside
    document.getElementById('videoModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeVideoModal();
      }
    });
    
  } catch (error) {
    console.error('Initialization error:', error);
    alert('Error initializing app. Please refresh the page.');
  }
});
</script>
</body>
</html>
